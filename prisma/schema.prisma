// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // poți schimba la postgresql/mysql dacă vrei
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  CART
  PENDING_PAYMENT
  PAID
  INVOICED
  FULFILLMENT
  SHIPPED
  COMPLETED
  CANCELED
  FAILED
}

enum PaymentStatus {
  REQUIRES_ACTION
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum ShipmentStatus {
  PENDING
  READY
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELED
}

model Customer {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Persoană fizică sau firmă (B2B)
  isCompany     Boolean  @default(false)
  fullName      String?
  email         String
  phone         String?

  // B2B
  companyName   String?
  cui           String?   // CUI (RO...)
  regCom        String?   // Nr. Registrul Comerțului

  billingAddress  Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])
  billingAddressId String?

  shippingAddress  Address? @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  shippingAddressId String?

  orders        Order[]
}

model Address {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String?  // destinatar (pentru livrare)
  street      String
  city        String
  state       String?  // județ
  postalCode  String
  country     String   @default("RO")
  phone       String?

  // relații inverse
  billingOf   Customer[] @relation("BillingAddress")
  shippingOf  Customer[] @relation("ShippingAddress")
  orderBilling Order[]   @relation("OrderBillingAddress")
  orderShipping Order[]  @relation("OrderShippingAddress")
}

model Order {
  id            String      @id @default(cuid())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  status        OrderStatus @default(CART)
  currency      String      @default("RON")

  subtotal      Decimal     @db.Decimal(10,2)
  shippingCost  Decimal     @db.Decimal(10,2)
  vatTotal      Decimal     @db.Decimal(10,2)
  discountTotal Decimal     @db.Decimal(10,2)
  total         Decimal     @db.Decimal(10,2)

  // greutate totală (pentru DPD)
  totalWeightGr Int         @default(0)

  customer      Customer?   @relation(fields: [customerId], references: [id])
  customerId    String?

  billingAddress   Address? @relation("OrderBillingAddress", fields: [billingAddressId], references: [id])
  billingAddressId String?

  shippingAddress  Address? @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  shippingAddressId String?

  items         OrderItem[]
  payment       Payment?
  shipment      Shipment?

  // legături Oblio / DPD
  oblioInvoiceId String?   // id/număr factură
  oblioInvoiceUrl String?
}

model OrderItem {
  id          String   @id @default(cuid())
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     String

  sku         String
  name        String
  quantity    Int
  unitPrice   Decimal @db.Decimal(10,2)
  vatRate     Decimal @db.Decimal(5,2) // ex. 19.00
  weightGr    Int     @default(0)

  // opțional: dimensiuni pentru DPD
  lengthMm    Int?    // lungime
  widthMm     Int?
  heightMm    Int?
}

model Payment {
  id              String         @id @default(cuid())
  order           Order          @relation(fields: [orderId], references: [id])
  orderId         String @unique

  provider        String         @default("stripe")
  status          PaymentStatus  @default(PENDING)
  amount          Decimal        @db.Decimal(10,2)
  currency        String         @default("RON")

  // Stripe
  stripePaymentIntentId String?  @unique
  stripeClientSecret     String?
}

model Shipment {
  id            String         @id @default(cuid())
  order         Order          @relation(fields: [orderId], references: [id])
  orderId       String @unique

  provider      String         @default("dpd")
  status        ShipmentStatus @default(PENDING)

  // DPD
  awb           String?
  labelUrl      String?
  trackingUrl   String?
}
